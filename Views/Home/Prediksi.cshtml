@{
    Layout = "~/Views/Shared/_LayoutNavbarOnly.cshtml";
    ViewData["Title"] = "Prediksi Home";
}

@section styles {
    <link href="~/lib/datatables.net-bs5/css/dataTables.bootstrap5.min.css" rel="stylesheet" type="text/css" />
    <link href="~/lib/datatables.net-responsive-bs5/css/responsive.bootstrap5.min.css" rel="stylesheet" type="text/css" />
    
    <style>
        .fa-clipboard:before, .fa-check:before {
            line-height: 1em;
            position: relative;
            top: 1.5rem;
            left: 1.6rem;
        }

        .fa-chart-pie:before {
            line-height: 1em;
            position: relative;
            top: 1.5rem;
            left: 1.5rem;
        }

        .muted {
            color: #FFFF !important;
        }

        .prediksi-img {
            width: 1500px; /* Make the image take the full width of its container */
            height: 212px; /* Maintain the aspect ratio */
            object-fit: cover; /* Optionally, crop the image to fit the container */
            border-radius: 5px; /* Optionally, add rounded corners */
        }

        .box-legend {
            display: inline-block;
            width: 1.2rem;
            height: 1.2rem;
            border-radius: 2px;
            margin-right: 0.4rem;
        }

        .prediksi-img {
            max-width: 90% !important;
        }

        .highcharts-figure,
        .highcharts-data-table table {
            min-width: 360px;
            max-width: 1600px;
            margin: 1em auto;
        }

        .highcharts-data-table table {
            font-family: Verdana, sans-serif;
            border-collapse: collapse;
            border: 1px solid #ebebeb;
            margin: 10px auto;
            text-align: center;
            width: 100%;
            max-width: 500px;
        }

        .highcharts-data-table caption {
            padding: 1em 0;
            font-size: 1.2em;
            color: #555;
        }

        .highcharts-data-table th {
            font-weight: 600;
            padding: 0.5em;
        }

        .highcharts-data-table td,
        .highcharts-data-table th,
        .highcharts-data-table caption {
            padding: 0.5em;
        }

        .highcharts-data-table thead tr,
        .highcharts-data-table tr:nth-child(even) {
            background: #f8f8f8;
        }

        .highcharts-data-table tr:hover {
            background: #f1f7ff;
        }
    </style>
}

<div class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="page-title-box">
                    <h4 class="page-title">Daerah Irigasi : Manganti</h4>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-4">
                <div class="widget-rounded-circle card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <div class="avatar-lg rounded-circle bg-soft-blue border-blue border">
                                    <i class="fas fa-check font-22 avatar-title text-blue"></i>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-end">
                                    <h3 class="text-dark mt-1"><span data-plugin="counterup" id="das-ketersediaan"></span></h3>
                                    <p class="text-muted mb-1 text-truncate">Ketersediaan(today)</p>
                                </div>
                            </div>
                        </div> <!-- end row-->
                    </div>
                </div> <!-- end widget-rounded-circle-->
            </div> <!-- end col-->

            <div class="col-md-4">
                <div class="widget-rounded-circle card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <div class="avatar-lg rounded-circle bg-soft-success border-success border">
                                    <i class="fas fa-clipboard font-24 avatar-title text-success"></i>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-end">
                                    <h3 class="text-dark mt-1"><span data-plugin="counterup" id="das-kebutuhan"></span></h3>
                                    <p class="text-muted mb-1 text-truncate">Kebutuhan(today)</p>
                                </div>
                            </div>
                        </div> <!-- end row-->
                    </div>
                </div> <!-- end widget-rounded-circle-->
            </div> <!-- end col-->

            <div class="col-md-4">
                <div class="widget-rounded-circle card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <div class="avatar-lg rounded-circle bg-soft-info border-info border">
                                    <i class="fas fa-chart-pie font-24 avatar-title text-info"></i>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-end">
                                    <h3 class="text-dark mt-1"><span data-plugin="counterup" id="das-presentase"></span></h3>
                                    <p class="text-muted mb-1 text-truncate">Presentase(today)</p>
                                </div>
                            </div>
                        </div> <!-- end row-->
                    </div>
                </div> <!-- end widget-rounded-circle-->
            </div> <!-- end col-->
        </div>

        @* <div class="row">
            <div class="col-6 col-md-6">
                <div class="card card-debit">
                    <div class="card-body">
                        <h4 class="header-title mb-2">Bendung Manganti</h4><br>
                        <center><img src="~/assets/img/map.jpg" alt="" class="prediksi-img"></center>
                    </div>
                     <!-- end card-body -->
                </div> <!-- end card-->
            </div>

            <div class=" col-6 col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h4 class="header-title mb-2">Debit Air Rata Rata per Wilayah Kerja</h4>
                        <div class="table-responsive">
                            <table class="table table-sm table-centered table-bordered table-hover mb-0 table-custom w-100" id="table-reading-awlr">
                                <thead class="bg-blue text-white">
                                    <tr>
                                        <th class="text-center">#</th>
                                        <th class="text-center">Bangunan Di</th>
                                        <th class="text-center">Petak Tertier</th>
                                        <th class="text-center">Jumlah Debit</th>
                                        <th class="text-center">Rata Rata Debit</th>
                                    </tr>
                                </thead>
                                <tbody class="text-center">
                                    <tr>
                                        <td>4</td>
                                        <td>BCIm 18 Kn</td>
                                        <td>60</td>
                                        <td>801</td>
                                        <td>53,40</td>
                                    </tr>
                                    <tr>
                                        <td>5</td>
                                        <td>BCIm 19 Kn</td>
                                        <td>40</td>
                                        <td>669</td>
                                        <td>44,60</td>
                                    </tr>
                                    <tr>
                                        <td>6</td>
                                        <td>B.Suplesi.2</td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                    </tr>
                                    <tr>
                                        <td>7</td>
                                        <td>BCIm 20a Kn</td>
                                        <td>35</td>
                                        <td>1.467</td>
                                        <td>97,80</td>
                                    </tr>
                                    <tr>
                                        <td>8</td>
                                        <td>BCIm 20 Kn</td>
                                        <td>43</td>
                                        <td>655</td>
                                        <td>43,67</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div> *@

        <div class="row">
            @* <div class=" col-6 col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h4 class="header-title mb-2">Realisasi Debit per Wilayah Juru</h4>
                        <div class="table-responsive">
                            <table class="table table-sm table-centered table-bordered table-hover mb-0 table-custom w-100" id="table-reading-awlr">
                                <thead class="bg-blue text-white">
                                    <tr>
                                        <th class="text-center">#</th>
                                        <th class="text-center">Wilayah Kerja</th>
                                        <th class="text-center">Luas Sawah</th>
                                        <th class="text-center">Debit Rata Rata</th>
                                        <th class="text-center">Debit Akhir</th>
                                        <th class="text-center">Usulan Luas</th>
                                        <th class="text-center">Keb Air Pintu Tertier</th>
                                    </tr>
                                </thead>
                                <tbody class="text-center">
                                    <tr>
                                        <td>4</td>
                                        <td>BCIm Kr 3</td>
                                        <td>44</td>
                                        <td>0</td>
                                        <td>0</td>
                                        <td>44</td>
                                        <td>38,28</td>
                                    </tr>
                                    <tr>
                                        <td>5</td>
                                        <td>BCIm Kr 4</td>
                                        <td>41</td>
                                        <td>0</td>
                                        <td>0</td>
                                        <td>41</td>
                                        <td>35,67</td>
                                    </tr>
                                    <tr>
                                        <td>6</td>
                                        <td>BCIm Kr 5</td>
                                        <td>5</td>
                                        <td>0</td>
                                        <td>0</td>
                                        <td>5</td>
                                        <td>4,35</td>
                                    </tr>
                                    <tr>
                                        <td>7</td>
                                        <td>BCIm Kn 6</td>
                                        <td>64</td>
                                        <td>0</td>
                                        <td>0</td>
                                        <td>64</td>
                                        <td>55,68</td>
                                    </tr>
                                    <tr>
                                        <td>8</td>
                                        <td>BCIm Kr 7</td>
                                        <td>62</td>
                                        <td>0</td>
                                        <td>0</td>
                                        <td>62</td>
                                        <td>53,94</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div> *@
            <div class="row">
                <div class="col-12 col-md-12">
                    <div class="card">
                        <div class="card-body">
                            <h4 class="header-title mb-3">Prediksi Debit Air di Bendung Manganti</h4>
                            <div class="btn-group mb-3 me-2 chart-buttons">
                                <a href="#" id="chart-line" class="btn btn-info active" aria-current="page">Grafik Garis</a>
                                <a href="#" id="chart-bar" class="btn btn-info">Grafik Batang</a>
                            </div>

                            <div class="btn-group mb-3 range-buttons">
                                @* <a href="#" id="range-1d" class="btn btn-blue active" aria-current="page">1 Hari</a> *@
                                <a href="#" id="range-7d" class="btn btn-blue active" aria-current="page">7 hari</a>
                                <a href="#" id="range-15d" class="btn btn-blue">15 Hari</a>
                                <a href="#" id="range-30d" class="btn btn-blue">30 Hari</a>
                            </div>

                            <figure class="highcharts-figure">
                                <div id="container"></div>
                                <p class="highcharts-description"></p>
                            </figure>
                            <br>
                            <table class="table table-sm table-centered table-bordered table-hover mb-0 table-custom w-100" id="ketersediaan-tbl">
                                <thead class="bg-blue text-white">
                                    <tr>
                                        <th class="text-center">#</th>
                                        <th class="text-center">Tanggal</th>
                                        <th class="text-center">Bangunan Di</th>
                                        <th class="text-center">Petak Tersier</th>
                                        <th class="text-center">Jumlah Debit</th>
                                        <th class="text-center">Min Debit</th>
                                        <th class="text-center">Max Debit</th>
                                        <th class="text-center">Rata Rata Debit</th>
                                    </tr>
                                </thead>
                                <tbody class="text-center">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>


            
        </div>
    </div>
</div>

@section scripts {
    <script src="~/lib/datatables.net/js/jquery.dataTables.min.js"></script>
    <script src="~/lib/datatables.net-bs5/js/dataTables.bootstrap5.min.js"></script>
    <script src="~/lib/datatables.net-responsive/js/dataTables.responsive.min.js"></script>
    <script src="~/lib/datatables.net-responsive-bs5/js/responsive.bootstrap5.min.js"></script>

    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/highcharts-more.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.js" integrity="sha512-ZwR1/gSZM3ai6vCdI+LVF1zSq/5HznD3ZSTk7kajkaj4D292NLuduDCO1c/NT8Id+jE58KYLKT7hXnbtryGmMg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://code.highcharts.com/modules/series-label.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
} 

@section additionalScripts {
    <script>
        var datatableKetersediaan;
        let chart;
        let chartType = 'spline'; // Default chart type
        let currentRange = '7d'; // Default range

        function setRange(range) {
            const today = new Date();
            const now = Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate());

            const millisecondsInADay = 24 * 60 * 60 * 1000;
            const futureDate = new Date(now + (30 * millisecondsInADay));
            const futureDateUTC = Date.UTC(futureDate.getUTCFullYear(), futureDate.getUTCMonth(), futureDate.getUTCDate());

            let min, max;

            switch(range) {
                case '7d':
                    min = now;
                    max = now + 7 * 24 * 3600 * 1000;
                    break;
                case '15d':
                    min = now;
                    max = now + 15 * 24 * 3600 * 1000;
                    break;
                case '30d':
                    min = now;
                    max = futureDateUTC;
                    break;
            }

            chart.xAxis[0].setExtremes(min, max);
            currentRange = range;
        }

        function createChart() {
            const today = new Date();

            const ketersediaanData = (() => {
                const startDate = new Date(); // Get today's date
                const data = [];
                for (let i = 0; i < 31; i++) {
                    const date = new Date(startDate);
                    date.setDate(startDate.getDate() + i); // Increment date by i days
                    const low = 500 + (Math.random() * 200); // Base low value around 400 with a small random variation
                    const high = low + (Math.random() * 200); // Base high value around low with a small random variation
                    data.push([Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate()), low, high]);
                }
                console.log('Ketersediaan Data:', data);
                return data;
            })();

            const todayKetersediaan = ketersediaanData.find(item => {
                const itemDate = new Date(item[0]);
                return itemDate.getUTCFullYear() === today.getUTCFullYear() &&
                    itemDate.getUTCMonth() === today.getUTCMonth() &&
                    itemDate.getUTCDate() === today.getUTCDate();
            });

            if (todayKetersediaan) {
                const ketersediaanValue = todayKetersediaan[1].toFixed(2);
                document.getElementById('das-ketersediaan').innerText = ketersediaanValue;
            }

            const avgData = ketersediaanData.map(d => {
                const date = d[0];
                const low = d[1];
                const high = d[2];
                const avg = (low + high) / 2;
                return [date, avg];
            });

            const kebutuhanData = (() => {
                const startDate = new Date(); // Get today's date
                const data = [];
                for (let i = 0; i < 31; i++) {
                    const date = new Date(startDate);
                    date.setDate(startDate.getDate() + i); // Increment date by i days
                    const value = 700 + (i * 5) + (Math.random() * 100 - 50); // Linear increase with larger random variation
                    data.push([Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate()), value]);
                }
                console.log('Kebutuhan Data:', data);
                return data;
            })();

            const todayKebutuhan = kebutuhanData.find(item => {
                const itemDate = new Date(item[0]);
                return itemDate.getUTCFullYear() === today.getUTCFullYear() &&
                    itemDate.getUTCMonth() === today.getUTCMonth() &&
                    itemDate.getUTCDate() === today.getUTCDate();
            });

            if (todayKebutuhan) {
                const kebutuhanValue = todayKebutuhan[1].toFixed(2);
                document.getElementById('das-kebutuhan').innerText = kebutuhanValue;
            }

            if (todayKetersediaan && todayKebutuhan) {
                const ketersediaanValue = todayKetersediaan[1].toFixed(2);
                const kebutuhanValue = todayKebutuhan[1].toFixed(2);

                // Calculate the presentase
                const valueBagi = ketersediaanValue / kebutuhanValue;
                const presentaseValue = (valueBagi * 100).toFixed(2) + '%';

                // Display the presentase value
                document.getElementById('das-presentase').innerText = presentaseValue;
            }

            chart = Highcharts.chart('container', {
                title: {
                    text: '',
                    align: 'left'
                },
                yAxis: {
                    title: {
                        text: 'm<sup>3</sup>/s'
                    },
                    min: 0,  // Set minimum value to 0
                    max: 1000 // Set maximum value to 1000
                },
                xAxis: {
                    type: 'datetime',
                    labels: {
                        format: '{value:%d %B %Y}', // Display day, month, and year
                        rotation: -45, // Rotate labels if needed
                        align: 'right'
                    },
                    tickInterval: 24 * 3600 * 1000, // One day interval
                    dateTimeLabelFormats: {
                        day: '%d %B %Y'
                    },
                    accessibility: {
                        rangeDescription: 'Range: March 2024'
                    }
                },
                legend: {
                    layout: 'vertical',
                    align: 'right',
                    verticalAlign: 'middle'
                },
                plotOptions: {
                    series: {
                        label: {
                            connectorAllowed: false
                        }
                    }
                },
                series: [{
                    name: 'Ketersediaan',
                    type: 'spline',
                    data: avgData,
                    zIndex: 1,
                    marker: {
                        fillColor: 'white',
                        lineWidth: 2,
                        lineColor: Highcharts.getOptions().colors[0]
                    },
                    tooltip: {
                        valueSuffix: ' ',
                        valueDecimals: 2,
                    }
                }, {
                    name: 'AVG',
                    data: ketersediaanData,
                    type: 'arearange',
                    lineWidth: 0,
                    linkedTo: ':previous',
                    color: Highcharts.getOptions().colors[0],
                    fillOpacity: 0.3,
                    zIndex: 0,
                    marker: {
                        enabled: false
                    },
                    tooltip: {
                        valueSuffix: ' ',
                        valueDecimals: 2,
                    }
                }, {
                    name: 'Kebutuhan', 
                    type: chartType,
                    color: '#404040', // Set color to black
                    data: kebutuhanData
                }],
                responsive: {
                    rules: [{
                        condition: {
                            maxWidth: 100
                        },
                        chartOptions: {
                            legend: {
                                layout: 'horizontal',
                                align: 'center',
                                verticalAlign: 'bottom'
                            }
                        }
                    }]
                }
            });

            setRange(currentRange); // Set the current range
        }

        document.addEventListener('DOMContentLoaded', function () {
            createChart();

            document.getElementById('range-7d').addEventListener('click', function (event) {
                event.preventDefault();
                setRange('7d');
                setActiveButton('range-7d', 'range-buttons');
            });
            document.getElementById('range-15d').addEventListener('click', function (event) {
                event.preventDefault();
                setRange('15d');
                setActiveButton('range-15d', 'range-buttons');
            });
            document.getElementById('range-30d').addEventListener('click', function (event) {
                event.preventDefault();
                setRange('30d');
                setActiveButton('range-30d', 'range-buttons');
            });

            document.getElementById('chart-line').addEventListener('click', function (event) {
                event.preventDefault();
                chartType = 'spline';
                recreateChart();
                setActiveButton('chart-line', 'chart-buttons');
            });
            document.getElementById('chart-bar').addEventListener('click', function (event) {
                event.preventDefault();
                chartType = 'column';
                recreateChart();
                setActiveButton('chart-bar', 'chart-buttons');
            });

            function setActiveButton(id, groupClass) {
                document.querySelectorAll('.' + groupClass + ' .btn').forEach(function (btn) {
                    btn.classList.remove('active');
                });
                document.getElementById(id).classList.add('active');
            }

            function recreateChart() {
                chart.destroy();
                createChart();
            }
        });

        var tblKetersediaan = (function() {
            var initDataTable = function() {
                dataTableKetersediaan = $("#ketersediaan-tbl").DataTable({
                    processing: true,
                    serverSide: true,
                    dom: "tipr",
                    order: [],
                    ajax: {
                        url: `/Home/GetDataKetersediaan`,
                        type: "POST",
                        dataType: "JSON",
                    },
                    columns: [
                        { data: null, name: "No", orderable: false, searchable: false }, 
                        {
                            data: "time",
                            name: "Time",
                            render: function(data, type, row) {
                                var date = new Date(data);
                                var formatDate = date.getFullYear() + '-' +
                                    ('0' + (date.getMonth() + 1)).slice(-2) + '-' +
                                    ('0' + date.getDate()).slice(-2) + ' ' + 
                                    ('0' + date.getHours()).slice(-2) + ':' + 
                                    ('0' + date.getMinutes()).slice(-2);
                                return formatDate;
                            }
                        },
                        { data: "bangunan", name: "Bangunan" },
                        { data: "petakTersier", name: "PetakTersier" },
                        { data: "debit", name: "Debit"},
                        { data: "min", name: "Min" },
                        { data: "max", name: "Max" },
                        { 
                            data: null, 
                            name: "Average", 
                            render: function(data, type, row) {
                                var debit = parseFloat(row.debit) || 0;
                                var min = parseFloat(row.min) || 0;
                                var max = parseFloat(row.max) || 0;
                                var avg = ((debit + min + max) / 3).toFixed(2);
                                return avg;
                            },
                            searchable: false,
                            orderable: false,
                        },
                    ],
                    columnDefs: [
                        {
                            targets: 0,
                            searchable: false,
                            orderable: false,
                            width: "9%",
                            className: "text-center",
                            render: function(data, type, row, meta) {
                                return meta.row + meta.settings._iDisplayStart + 1;
                            }
                        },
                        {
                            targets: -1,
                            searchable: false,
                            orderable: false,
                            width: "18%",
                            className: "text-center",
                        },
                    ],
                    language: {
                        url: '/data/datatable_locale_id.json',
                        paginate: {
                            previous: "<i class='mdi mdi-chevron-left'>",
                            next: "<i class='mdi mdi-chevron-right'>"
                        }
                    },
                    drawCallback: function () {
                        $('.dataTables_paginate > .pagination').addClass('pagination-rounded');
                    }
                });

               datatableKetersediaan.on('draw.dt', function () {
                    var info = datatableKetersediaan.page.info();
                    datatableKetersediaan.column(0, { search: 'applied', order: 'applied', page: 'applied' }).nodes().each(function (cell, i) {
                        cell.innerHTML = i + 1 + info.start;
                    });
                });
            }
            return {
                init: function () {
                    initDataTable();
                },
            };
        })();

        $(document).ready(function() {
            tblKetersediaan.init();
        });
    </script>
}
