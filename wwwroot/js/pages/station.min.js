"use strict";var dtStation,currentYear=(new Date).getFullYear(),DataStation={init:function(){null==stationId?$("#form-device-id").hide():$("#form-device-id").show(),$('input[name="IsNewDevice"]').change(function(){"false"==$('input[name="IsNewDevice"]:checked').val()?($("#form-device-id").fadeIn(300),$("#DeviceId").attr("required",!0)):($("#form-device-id").fadeOut(300),$("#DeviceId").attr("required",!1))}),loadAdditionalForm(),$(".parsley-validation").parsley(),$(".selectize-parsley").on("change",function(){$(this).parsley().removeError("required",{updateClass:!0})}),$("#search-station-table").keyup(function(){dtStation.search($(this).val()).draw()}),$("#length-station-table").change(function(){dtStation.page.len($(this).val()).draw()}),$(".filter_station").change(function(){dtStation.ajax.reload()}),$('[data-plugins="dropify"]').length>0&&$('[data-plugins="dropify"]').dropify({messages:{default:"Upload Foto",replace:"Upload Foto",remove:"Hapus",error:"Ooops, something wrong appended."},fileSize:"2M",error:{fileSize:"Ukuran file terlalu besar (maksimal 2MB)."}}),$("#Type").on("change",function(){loadAdditionalForm()}),$("#BrandCode").on("change",function(){"b001"==$(this).val().toLowerCase()?($("#form-device-id").fadeOut(300),$("#form-confirm-device").fadeIn(300)):($("#form-device-id").fadeIn(300),$("#form-confirm-device").fadeOut(300))}),window.Parsley.addValidator("siaga1",{validateString:function(e,a){var t=$(".input-siaga2").val();return null!=t&&""!=t&&parseFloat(e)>parseFloat(t)},messages:{en:"Nilai Siaga 1 harus lebih besar dari Siaga 2"}}),window.Parsley.addValidator("siaga2",{validateString:function(e,a){var t=$(".input-siaga1").val(),n=$(".input-siaga3").val();return null!=t&&""!=t&&null!=n&&""!=n&&(parseFloat(e)<parseFloat(t)||parseFloat(e)>parseFloat(n))},messages:{en:"Nilai Siaga 2 harus lebih besar dari Siaga 3 dan lebih kecil dari Siaga 1"}}),window.Parsley.addValidator("siaga3",{validateString:function(e,a){var t=$(".input-siaga2").val();return(null!=t||""!=t)&&parseFloat(e)<parseFloat(t)},messages:{en:"Nilai Siaga 3 harus lebih kecil dari Siaga 2"}}),window.Parsley.addValidator("double",{validateString:function(e){return/^-?\d*(\.\d+)?$/.test(e)},messages:{en:"Format angka tidak valid. Contoh: 0.5"}}),window.Parsley.addValidator("latitude",{validateString:function(e){return/^-?([0-8]?[0-9]|90)(\.\d{1,16})?$/.test(e)},messages:{en:"Format latitude tidak valid. Contoh: -0.9767567"}}),window.Parsley.addValidator("longitude",{validateString:function(e){return/^-?((1[0-7][0-9]|[0-9]{1,2})(\.\d{1,16})?|180(\.0{1,6})?)$/.test(e)},messages:{en:"Format longitude tidak valid. Contoh: 117.3422262"}}),$("#BuiltYear").length>0&&$("#RenovationYear").length>0&&$("#BuiltYear, #RenovationYear").datepicker({autoclose:!0,format:"yyyy",startView:2,minViewMode:2,endDate:new Date}),$("#InstalledDate").length>0&&$("#InstalledDate").flatpickr({dateFormat:"Y-m-d",maxDate:new Date}),$("#RiverAreaId").on("change",function(){var e=$("#WatershedId")[0].selectize;e.setValue(null),e.clearOptions(),e.disable(),e.$control_input.attr("placeholder","Loading...");var a=$(this).val();getData(`/Watershed/GetAllByRiverAreaId/${a}`).then(a=>{let t=a.data;200==t.code&&$.each(t.response,function(a,t){e.addOption({value:t.id,text:t.name})}),e.enable(),e.$control_input.attr("placeholder","Pilih Daerah Aliran Sungai...")}).catch(e=>{let a=e.response.data;a.success||alert(a.message)})}),$("#ProvinceId").on("change",function(){var e=$("#RegencyId")[0].selectize;e.setValue(null),e.clearOptions(),e.disable(),e.$control_input.attr("placeholder","Loading...");var a=$(this).val();getData(`/Global/GetRegencyByProvinceId/${a}`).then(a=>{let t=a.data;200==t.code&&$.each(t.response,function(a,t){e.addOption({value:t.id,text:t.name})}),e.enable(),e.$control_input.attr("placeholder","Pilih Kota / Kabupaten...")}).catch(e=>{let a=e.response.data;a.success||alert(a.message)})}),$("#RegencyId").on("change",function(){var e=$("#DistrictId")[0].selectize;e.setValue(null),e.clearOptions(),e.disable(),e.$control_input.attr("placeholder","Loading...");var a=$(this).val();getData(`/Global/GetDistrictByRegencyId/${a}`).then(a=>{let t=a.data;200==t.code&&$.each(t.response,function(a,t){e.addOption({value:t.id,text:t.name})}),e.enable(),e.$control_input.attr("placeholder","Pilih Kecamatan...")}).catch(e=>{let a=e.response.data;a.success||alert(a.message)})}),$("#DistrictId").on("change",function(){var e=$("#VillageId")[0].selectize;e.setValue(null),e.clearOptions(),e.disable(),e.$control_input.attr("placeholder","Loading...");var a=$(this).val();getData(`/Global/GetVillageByDistrictId/${a}`).then(a=>{let t=a.data;200==t.code&&$.each(t.response,function(a,t){e.addOption({value:t.id,text:t.name})}),e.enable(),e.$control_input.attr("placeholder","Pilih Kelurahan / Desa...")}).catch(e=>{let a=e.response.data;a.success||alert(a.message)})}),(dtStation=$("#table-station").DataTable({processing:!0,serverSide:!0,dom:"tipr",order:[],ajax:{url:"/Station/GetDatatableStation",type:"POST",dataType:"JSON",data:function(e){e.watershed_id=getValueById("filter_watershed"),e.brand_code=getValueById("filter_brand"),e.type=getValueById("filter_type"),e.device_status=getValueById("filter_device_status")}},columns:[{data:null},{data:"name",name:"Name",render:function(e,a,t){var n="/images/default-pu.png";null!==t.photo&&(n=`/uploads/images/stations/${t.photo}`);let i="";return i="AWLR"==t.type?'<span class="badge bg-soft-blue text-blue rounded-1 shadow-sm px-1" style="padding: 0.3rem 0.1rem;">Pos Duga Air</span>':"ARR"==t.type?'<span class="badge bg-soft-success text-success rounded-1 shadow-sm px-1" style="padding: 0.3rem 0.1rem;">Pos Curah Hujan</span>':"AWLR_ARR"==t.type?'<span class="badge bg-soft-warning text-warning rounded-1 shadow-sm px-1" style="padding: 0.3rem 0.1rem;">PDA & PCH</span>':"AWS"==t.type?'<span class="badge bg-soft-danger text-danger rounded-1 shadow-sm px-1" style="padding: 0.3rem 0.1rem;">Pos Klimatologi</span>':"",`<div class="d-flex align-items-start">\n                                <a class="image-popup-single" href="${n}" title="${t.name}" style="cursor: zoom-in;">\n                                    <img src="${n}" class="me-2 rounded" height="42" width="42" alt="${t.name}">\n                                </a>\n                            <div>\n                                <h5 class="mt-0 font-13" style="margin-bottom: 0.3rem;">\n                                    <a href="/Station/Detail/${t.slug}" target="_blank" class="text-reset">${e}</a>\n                                </h5>\n                                ${i}\n                            </div>\n                        </div>`}},{data:"watershedName",name:"WatershedName",render:function(e,a,t){return e}},{data:"brandName",name:"BrandName",render:function(e,a,t){return e}},{data:"deviceId",name:"DeviceId"},{data:"lastReadingAt",name:"LastReadingAt"},{data:"deviceStatus",name:"DeviceStatus",render:function(e,a,t){let n='<p class="mt-1 mb-0 text-muted font-12">\n                            <small class="mdi mdi-circle text-danger m-0"></small> Offline\n                        </p>';return null!=t.lastReadingAt&&"online"==e&&(n='<p class="mt-1 mb-0 text-muted font-12">\n                                <small class="mdi mdi-circle text-success m-0"></small> Online\n                            </p>'),n}},{render:function(e,a,t){var n=`<div class="btn-group dropdown">\n                                <a href="javascript: void(0);" class="table-action-btn dropdown-toggle arrow-none btn btn-light btn-sm" data-bs-toggle="dropdown" aria-expanded="false"><i class="mdi mdi-dots-horizontal"></i></a>\n                                <div class="dropdown-menu dropdown-menu-end">\n                                    <a class="dropdown-item" href="/station/detail/${t.slug}" target="_blank"><i class="mdi mdi-eye me-2 text-muted font-18 vertical-middle"></i>Lihat Detail</a>\n                                    <a class="dropdown-item" href="/station/${t.id}/edit"><i class="mdi mdi-square-edit-outline me-2 text-muted font-18 vertical-middle"></i>Edit</a>\n                                    <a class="dropdown-item" href="#"><i class="mdi mdi-delete me-2 text-muted font-18 vertical-middle"></i>Hapus</a>\n                                </div>\n                            </div>`;return"B001"!=t.brandCode&&(n+=`<button type="button" class="btn btn-xs btn-danger rounded-2" data-id="${t.id}" onclick="showMessage('info', 'Mohon Maaf', 'Fitur sedang dalam pengembangan.');"><i class="mdi mdi-delete"></i></button>`),n}}],columnDefs:[{targets:0,searchable:!1,orderable:!1,width:"6%",className:"text-center"},{targets:5,render:function(e){const a=moment().format("YYYY-MMM-DD");return null!=e?moment(e).format("YYYY-MMM-DD")==a?`Hari Ini <span class="text-muted">${moment(e).format("HH:mm")}</span>`:`${moment(e).locale("id").format("D-MMM-YYYY")} <span class="text-muted">${moment(e).format("HH:mm")}</span>`:null}},{targets:-1,searchable:!1,orderable:!1,className:"text-center"}],language:{url:"/data/datatable_locale_id.json",paginate:{previous:"<i class='mdi mdi-chevron-left'>",next:"<i class='mdi mdi-chevron-right'>"}},drawCallback:function(){$(".dataTables_paginate > .pagination").addClass("pagination-rounded"),initPopupImage()}})).on("draw.dt",function(){var e=dtStation.page.info();dtStation.column(0,{search:"applied",order:"applied",page:"applied"}).nodes().each(function(a,t){a.innerHTML=t+1+e.start})})}};function loadAdditionalForm(){var e=$("#Type").val();if("AWLR"==e||"AWLR_ARR"==e){var a=new FormData;null==stationId?(a.append("stationId",""),a.append("deviceId","")):(a.append("stationId",stationId),a.append("deviceId",getValueById("DeviceId"))),postData("/Station/GetAwlrStationForm",a).then(e=>{let a=e.data;$("#form-awlr").html(a)})}else if("AWS"==e){$("#form-awlr").empty();a=new FormData;null==stationId?(a.append("stationId",""),a.append("deviceId","")):(a.append("stationId",stationId),a.append("deviceId",getValueById("DeviceId"))),postData("/Station/GetAwsStationForm",a).then(e=>{let a=e.data;$("#form-aws").html(a)})}else $("#form-awlr, #form-aws").empty()}function resetFilter(){var e=$("#filter_watershed")[0].selectize,a=$("#filter_brand")[0].selectize,t=$("#filter_type")[0].selectize,n=$("#filter_device_status")[0].selectize;e.setValue("all"),a.setValue("all"),t.setValue("all"),n.setValue("all")}function initPopupImage(){$(".image-popup-single").magnificPopup({type:"image",closeOnContentClick:!1,closeBtnInside:!1,mainClass:"mfp-with-zoom mfp-img-mobile",image:{verticalFit:!0,titleSrc:function(e){return e.el.attr("title")}},zoom:{enabled:!0,duration:300,opener:function(e){return e.find("img")}}})}jQuery(document).ready(function(){DataStation.init()}),window.createStation=((e,a)=>{if(a.preventDefault(),$("#form-create").parsley().validate(),$("#form-create").parsley().isValid()){beforeLoadingButton($(e),"Menyimpan Data Pos...");var t=new FormData;let a=document.querySelector("#StationImage");if(t.append("StationImage",a.files[0]?a.files[0]:null),t.append("StationName",getValueById("Name")),t.append("StationType",getValueById("Type")),t.append("NoRegister",getValueById("NoRegister")),t.append("Elevation",getValueById("Elevation")),t.append("RiverAreaId",getValueById("RiverAreaId")),t.append("WatershedId",getValueById("WatershedId")),t.append("BuiltBy",getValueById("BuiltBy")),t.append("BuiltYear",getValueById("BuiltYear")),t.append("RenovationBy",getValueById("RenovationBy")),t.append("RenovationYear",getValueById("RenovationYear")),t.append("Note",getValueById("Note")),t.append("Latitude",getValueById("Latitude")),t.append("Longitude",getValueById("Longitude")),t.append("ProvinceId",getValueById("ProvinceId")),t.append("RegencyId",getValueById("RegencyId")),t.append("DistrictId",getValueById("DistrictId")),t.append("VillageId",getValueById("VillageId")),t.append("TimeZone",timeZone1),t.append("BrandCode",getValueById("BrandCode")),t.append("IsNewDevice",$('input[name="IsNewDevice"]:checked').val()),t.append("DeviceId",getValueById("DeviceId")),t.append("NoGsm",getValueById("NoGsm")),t.append("InstalledDate",getValueById("InstalledDate")),t.append("Calibration",getValueById("Calibration")),"AWLR"==getValueById("Type")||"AWLR_ARR"==getValueById("Type"))t.append("UnitSensor",getValueById("UnitSensor")),t.append("UnitDisplay",getValueById("UnitDisplay")),t.append("Siaga1",getValueById("Siaga1")),t.append("Siaga2",getValueById("Siaga2")),t.append("Siaga3",getValueById("Siaga3")),t.append("KonstantaA",getValueById("KonstantaA")),t.append("KonstantaB",getValueById("KonstantaB")),t.append("PeilschaalBasisValue",getValueById("PeilschaalBasisValue")),t.append("PeilschaalBasisElevation",getValueById("PeilschaalBasisElevation")),"Bendung"==organizationCategory&&t.append("HeightMercu",getValueById("HeightMercu"));else if("AWS"==getValueById("Type")){var n=0;$('input[name="sensor[]"]:checked').each(function(){t.append(`Sensor[${n}]`,$(this).val()),n++})}postData("/Station/Create",t).then(a=>{let t=a.data;200==t.code?Swal.fire({icon:"success",title:"Berhasil!",text:"Data Pos berhasil disimpan.",showCancelButton:!1,confirmButtonText:"OK",allowOutsideClick:!1}).then(e=>{e.isConfirmed&&(window.location.href="/Station")}):showMessage("error","Perhatian!",t.message),afterLoadingButton($(e),"Simpan Data Pos")}).catch(a=>{console.log(a),afterLoadingButton($(e),"Simpan Data Pos")})}}),window.updateStation=((e,a)=>{if(a.preventDefault(),$("#form-create").parsley().validate(),$("#form-create").parsley().isValid()){beforeLoadingButton($(e),"Menyimpan Data Pos...");var t=new FormData;t.append("Id",getValueById("Id"));let a=document.querySelector("#StationImage");if(t.append("StationImage",a.files[0]?a.files[0]:null),t.append("StationName",getValueById("Name")),t.append("StationType",getValueById("Type")),t.append("NoRegister",getValueById("NoRegister")),t.append("Elevation",getValueById("Elevation")),t.append("RiverAreaId",getValueById("RiverAreaId")),t.append("WatershedId",getValueById("WatershedId")),t.append("BuiltBy",getValueById("BuiltBy")),t.append("BuiltYear",getValueById("BuiltYear")),t.append("RenovationBy",getValueById("RenovationBy")),t.append("RenovationYear",getValueById("RenovationYear")),t.append("Note",getValueById("Note")),t.append("Latitude",getValueById("Latitude")),t.append("Longitude",getValueById("Longitude")),t.append("ProvinceId",getValueById("ProvinceId")),t.append("RegencyId",getValueById("RegencyId")),t.append("DistrictId",getValueById("DistrictId")),t.append("VillageId",getValueById("VillageId")),t.append("TimeZone",timeZone1),t.append("BrandCode",getValueById("BrandCode")),t.append("IsNewDevice",$('input[name="IsNewDevice"]:checked').val()),t.append("DeviceId",getValueById("DeviceId")),t.append("NoGsm",getValueById("NoGsm")),t.append("InstalledDate",getValueById("InstalledDate")),t.append("Calibration",getValueById("Calibration")),"AWLR"==getValueById("Type")||"AWLR_ARR"==getValueById("Type"))t.append("UnitSensor",getValueById("UnitSensor")),t.append("UnitDisplay",getValueById("UnitDisplay")),t.append("Siaga1",getValueById("Siaga1")),t.append("Siaga2",getValueById("Siaga2")),t.append("Siaga3",getValueById("Siaga3")),t.append("KonstantaA",getValueById("KonstantaA")),t.append("KonstantaB",getValueById("KonstantaB")),t.append("PeilschaalBasisValue",getValueById("PeilschaalBasisValue")),t.append("PeilschaalBasisElevation",getValueById("PeilschaalBasisElevation")),"Bendung"==organizationCategory&&t.append("HeightMercu",getValueById("HeightMercu"));else if("AWS"==getValueById("Type")){var n=0;$('input[name="sensor[]"]:checked').each(function(){t.append(`Sensor[${n}]`,$(this).val()),n++})}postData("/Station/Update",t).then(a=>{let t=a.data;200==t.code?Swal.fire({icon:"success",title:"Berhasil!",text:"Data Pos berhasil diubah.",showCancelButton:!1,confirmButtonText:"OK",allowOutsideClick:!1}).then(e=>{e.isConfirmed&&(window.location.href="/Station")}):showMessage("error","Perhatian!",t.message),afterLoadingButton($(e),"Simpan Perubahan")}).catch(a=>{console.log(a),afterLoadingButton($(e),"Simpan Perubahan")})}});